<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantiaくじ商品分析ツール (GitHub版)</title>
    <!-- Tailwind CSSを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 日本語フォントと基本フォントを適用 */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* ファイル入力のデザインを改善 */
        #csvFileInput {
            transition: all 0.3s ease-in-out;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        /* モーダルのスタイル */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- パスワード認証画面 -->
    <div id="password-container" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">認証が必要です</h2>
            <form id="password-form">
                <div class="mb-4">
                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-2">パスワード</label>
                    <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="パスワードを入力" disabled>
                </div>
                <p id="error-message" class="hidden text-red-500 text-sm mb-4 text-center">パスワードが違います。</p>
                
                <div class="mb-4 flex items-center">
                    <input type="checkbox" id="show-password-toggle" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" disabled>
                    <label for="show-password-toggle" class="text-sm font-medium text-gray-700 select-none cursor-pointer">パスワードを表示する</label>
                </div>
                
                <button type="submit" id="login-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <span id="login-button-text">ログイン</span>
                    <span id="login-button-spinner" class="hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        処理中...
                    </span>
                </button>
                <p id="password-loading-message" class="text-sm text-gray-500 text-center mt-4">認証システムを準備中...</p>
            </form>
        </div>
    </div>
    
    <!-- メインコンテンツ -->
    <div id="main-content" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- ヘッダー -->
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">CSVくじ商品分析ツール</h1>
                <p class="text-gray-600 mt-2">Fantiaの注文CSVをアップロードして、売上データを分析します。</p>
            </header>

            <!-- 2カラムレイアウト -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- 左カラム: コントロールパネル -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- キャスト管理 -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">キャスト管理</h2>
                        
                        <!-- キャスト選択 -->
                        <div class="mb-4">
                            <label for="castSelector" class="block text-sm font-medium text-gray-700 mb-2">分析するキャスト</label>
                            <select id="castSelector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:bg-gray-100" disabled>
                                <option value="">選択してください</option>
                            </select>
                        </div>
                        
                        <!-- キャスト追加 -->
                        <div>
                            <label for="newCastNameInput" class="block text-sm font-medium text-gray-700 mb-2">キャストを追加</label>
                            <div class="flex space-x-2">
                                <input type="text" id="newCastNameInput" placeholder="キャスト名" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:bg-gray-100" disabled>
                                <button id="addCastButton" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>追加</button>
                            </div>
                            <p id="castError" class="text-red-500 text-sm mt-2"></p>
                            <p id="cast-loading-message" class="text-sm text-gray-500 text-center mt-4">データベースに接続中...</p>
                        </div>
                    </div>

                    <!-- ファイルアップロード -->
                    <div id="upload-section" class="bg-white rounded-xl shadow-lg p-6 border border-gray-200 hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">データ更新</h2>
                        <div class="flex flex-col items-center">
                            <svg class="w-12 h-12 text-blue-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <label for="csvFileInput" class="w-full cursor-pointer text-center text-sm font-medium text-gray-700 mb-2">
                                CSVファイルを選択（注文ID基準で上書きされます）
                            </label>
                            <input type="file" id="csvFileInput" accept=".csv" class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100
                            "/>
                        </div>
                    </div>
                </div>

                <!-- 右カラム: 結果表示 -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- 検索バー -->
                    <div id="search-section" class="bg-white rounded-xl shadow-lg p-4 border border-gray-200 hidden">
                         <div class="relative">
                            <input type="text" id="searchInput" placeholder="商品名で検索..." class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                        </div>
                    </div>

                    <!-- ローディングスピナー -->
                    <div id="loadingIndicator" class="hidden text-center mt-8 pt-10">
                        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-500 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-4 text-gray-600">データを分析中...</p>
                    </div>

                    <!-- 結果表示コンテナ -->
                    <div id="resultsContainer" class="space-y-6">
                        <!-- 分析結果がここに動的に挿入されます -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 日別詳細モーダル -->
    <div id="dailyDetailsModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-xl shadow-lg w-full max-w-3xl m-4 transform scale-95">
            <!-- モーダルヘッダー -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
                <button onclick="hideDailyDetailsModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- モーダルボディ -->
            <div id="modalBody" class="p-6 max-h-[70vh] overflow-y-auto">
                <!-- データテーブルがここに挿入されます -->
            </div>
        </div>
    </div>


    <!-- 
        Firebase と アプリケーションロジック
        認証とアプリ本体のロジックを1つのモジュールに統合
    -->
    <script type="module">
        // Firebase SDK のインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection, 
            onSnapshot, 
            writeBatch, 
            query, 
            setLogLevel,
            getDocs // getDocs をインポート
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- グローバル変数・定数 ---
        let db, auth, userId, appId, correctPasswordHash; // correctPasswordHash は平文パスワードを保持する変数名として流用
        let globalDailyStats = {}; // 日別データをグローバルに保持

        // --- DOM要素 ---
        let passwordContainer, mainContent, passwordForm, passwordInput, errorMessage, 
            showPasswordToggle, loginButton, loginButtonText, loginButtonSpinner, 
            passwordLoadingMessage, castSelector, newCastNameInput, addCastButton, 
            castError, castLoadingMessage, uploadSection, fileInput, searchSection, 
            searchInput, loadingIndicator, resultsContainer, 
            dailyDetailsModal, modalTitle, modalBody;

        /**
         * Cookieを設定します。
         */
        function setCookie(name, value, years) {
            let expires = "";
            if (years) {
                const date = new Date();
                date.setTime(date.getTime() + (years * 365 * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/; SameSite=Lax";
        }

        /**
         * Cookieを取得します。
         */
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i=0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }

        /**
         * メインコンテンツを表示し、アプリの初期化（イベントリスナー設定）を行います。
         */
        function showMainContentAndInitApp() {
            passwordContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            setupEventListeners();
        }

        /**
         * パスワード認証フォームを有効化します。
         */
        function enablePasswordForm() {
            passwordInput.disabled = false;
            showPasswordToggle.disabled = false;
            loginButton.disabled = false;
            passwordLoadingMessage.textContent = '認証準備完了';
            passwordLoadingMessage.classList.remove('text-gray-500');
            passwordLoadingMessage.classList.add('text-green-600');
        }

        // --- メインアプリロジック ---

        /**
         * アプリのメイン初期化処理
         */
        async function initializeMainApp() {
            // 1. DOM要素の取得
            passwordContainer = document.getElementById('password-container');
            mainContent = document.getElementById('main-content');
            passwordForm = document.getElementById('password-form');
            passwordInput = document.getElementById('password-input');
            errorMessage = document.getElementById('error-message');
            showPasswordToggle = document.getElementById('show-password-toggle');
            loginButton = document.getElementById('login-button');
            loginButtonText = document.getElementById('login-button-text');
            loginButtonSpinner = document.getElementById('login-button-spinner');
            passwordLoadingMessage = document.getElementById('password-loading-message');
            castSelector = document.getElementById('castSelector');
            newCastNameInput = document.getElementById('newCastNameInput');
            addCastButton = document.getElementById('addCastButton');
            castError = document.getElementById('castError');
            castLoadingMessage = document.getElementById('cast-loading-message');
            uploadSection = document.getElementById('upload-section');
            fileInput = document.getElementById('csvFileInput');
            searchSection = document.getElementById('search-section');
            searchInput = document.getElementById('searchInput');
            loadingIndicator = document.getElementById('loadingIndicator');
            resultsContainer = document.getElementById('resultsContainer');
            dailyDetailsModal = document.getElementById('dailyDetailsModal');
            modalTitle = document.getElementById('modalTitle');
            modalBody = document.getElementById('modalBody');

            // 2. Firebase設定
            try {
                // ▼▼▼ 変更: ここにFirebaseプロジェクトの設定を貼り付け ▼▼▼
                // (ステップ1.4でコピーした const firebaseConfig = { ... } を貼り付けます)
                
                // 【！！重要！！】
                // 以下の firebaseConfig の値を、あなたのFirebaseプロジェクトの値に書き換えてください。
                // "YOUR_API_KEY_HERE" のままでは `auth/api-key-not-valid` エラーが発生します。
                // Firebaseコンソール > プロジェクト設定 (歯車アイコン) > 全般 > マイアプリ で確認できます。
                const firebaseConfig = {
                  apiKey: "AIzaSyDDz9cs9Wgx8Npjrh7FwUB4kF1h8Zwsiik",
                  authDomain: "fantia-csv.firebaseapp.com",
                  projectId: "fantia-csv",
                  storageBucket: "fantia-csv.firebasestorage.app",
                  messagingSenderId: "457081920405",
                  appId: "1:457081920405:web:6a33cb7f82e1ff7739f49c",
                  measurementId: "G-W1XS2E6VZ9"
                };
                // ▲▲▲ 変更 ▲▲▲

                // ▼▼▼ 変更: appIdを固定の文字列に設定 ▼▼▼
                // (セキュリティルール /artifacts/ここの文字列/public/... と一致させる)
                appId = 'fantia-analyzer-app'; 

                // 3. Firebase初期化
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); // デバッグ用

                // 4. 匿名認証
                await signInAnonymously(auth);

                // 5. 認証状態の監視
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase 匿名認証成功. UserID:", userId);

                        // 6. DBからパスワード（平文）を取得
                        try {
                            const passDocRef = doc(db, `artifacts/${appId}/public/data/config/password`);
                            const passDocSnap = await getDoc(passDocRef);
                            
                            if (passDocSnap.exists()) {
                                // データベースに保存されている平文のパスワードを取得
                                // フィールド名が 'hash' のままでも中身が平文ならOK
                                correctPasswordHash = passDocSnap.data().hash; 
                                console.log("パスワードの取得成功。");
                                
                                // 7. パスワード認証処理
                                // 認証済みかCookieでチェック（Cookieの値も平文パスワード）
                                if (getCookie('auth_token_lottery_analyzer') === correctPasswordHash) {
                                    showMainContentAndInitApp();
                                    loadCasts(); // メインアプリのキャスト読み込み開始
                                } else {
                                    // 認証フォームを有効化
                                    enablePasswordForm();
                                }
                            } else {
                                // パスワードがDBに設定されていない
                                console.error("Firestoreにパスワードが設定されていません。");
                                passwordLoadingMessage.textContent = 'エラー: 管理者が未設定です。';
                                passwordLoadingMessage.classList.add('text-red-500');
                            }
                        } catch (err) {
                            console.error("パスワードの取得に失敗:", err);
                            passwordLoadingMessage.textContent = 'エラー: DB接続に失敗しました。';
                            passwordLoadingMessage.classList.add('text-red-500');
                        }
                        
                        // 8. パスワード認証フォームのイベントリスナー設定
                        setupPasswordFormListeners();

                    } else {
                        // 匿名認証に失敗した場合
                        console.error("Firebase 匿名認証に失敗しました。");
                        passwordLoadingMessage.textContent = 'エラー: 認証サーバに接続できません。';
                        passwordLoadingMessage.classList.add('text-red-500');
                    }
                });

            } catch (error) {
                console.error("Firebase 初期化エラー:", error);
                passwordLoadingMessage.textContent = 'エラー: 初期化に失敗しました。';
                passwordLoadingMessage.classList.add('text-red-500');
            }
        }

        /**
         * パスワード認証フォームのイベントリスナーを設定します。
         */
        function setupPasswordFormListeners() {
            // パスワードフォームの送信イベント
            passwordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginButton.disabled = true;
                loginButtonText.classList.add('hidden');
                loginButtonSpinner.classList.remove('hidden');

                const inputPassword = passwordInput.value;
                // ハッシュ化の処理を削除

                // デバッグ用ログ
                console.log("入力されたパスワード:", inputPassword);
                console.log("期待されるパスワード:", correctPasswordHash);

                // 平文のまま比較
                if (inputPassword === correctPasswordHash) {
                    // 認証成功
                    setCookie('auth_token_lottery_analyzer', inputPassword, 10); // Cookieにも平文を保存
                    showMainContentAndInitApp();
                    loadCasts(); // メインアプリのキャスト読み込み開始
                } else {
                    // 認証失敗
                    errorMessage.classList.remove('hidden');
                    passwordInput.value = '';
                    loginButton.disabled = false;
                    loginButtonText.classList.remove('hidden');
                    loginButtonSpinner.classList.add('hidden');
                }
            });

            // パスワード入力欄で入力を開始したらエラーメッセージを消す
            passwordInput.addEventListener('input', () => {
                errorMessage.classList.add('hidden');
            });
            
            // 「パスワードを表示する」チェックボックスの処理
            if (showPasswordToggle) {
                showPasswordToggle.addEventListener('change', () => {
                    passwordInput.type = showPasswordToggle.checked ? 'text' : 'password';
                });
            }
        }

        /**
         * メインアプリのイベントリスナーを設定します。
         */
        function setupEventListeners() {
            // キャスト選択
            castSelector.addEventListener('change', (e) => {
                const castId = e.target.value;
                if (castId) {
                    loadCastData(castId);
                    uploadSection.classList.remove('hidden');
                } else {
                    uploadSection.classList.add('hidden');
                    resultsContainer.innerHTML = '';
                    searchSection.classList.add('hidden');
                }
            });

            // キャスト追加ボタン
            addCastButton.addEventListener('click', handleAddCast);
            
            // キャスト追加Enterキー
            newCastNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleAddCast();
                }
            });

            // ファイル入力
            fileInput.addEventListener('change', handleFileSelect);
            
            // 検索入力
            searchInput.addEventListener('input', applySearchFilter);
        }

        /**
         * キャスト管理UIを有効化します。
         */
        function enableCastManagement() {
            castSelector.disabled = false;
            newCastNameInput.disabled = false;
            addCastButton.disabled = false;
            castLoadingMessage.classList.add('hidden');
        }

        /**
         * Firestoreからキャスト一覧を読み込みます。
         */
        function loadCasts() {
            console.log("キャスト一覧の読み込み開始...");
            const castsColRef = collection(db, `artifacts/${appId}/public/data/casts`);
            const q = query(castsColRef); // 将来的なソートのために query を使用

            onSnapshot(q, (snapshot) => {
                console.log("キャスト一覧のデータ更新を検知");
                const casts = [];
                snapshot.forEach((doc) => {
                    casts.push({ id: doc.id, name: doc.data().name });
                });
                
                // Firestoreから取得したデータを名前でソート
                casts.sort((a, b) => a.name.localeCompare(b.name, 'ja'));

                // ドロップダウンを更新
                const currentCastId = castSelector.value;
                castSelector.innerHTML = '<option value="">選択してください</option>';
                casts.forEach(cast => {
                    const option = document.createElement('option');
                    option.value = cast.id;
                    option.textContent = cast.name;
                    castSelector.appendChild(option);
                });
                
                // 選択状態を復元
                if (currentCastId) {
                    castSelector.value = currentCastId;
                }
                
                // UIを有効化
                enableCastManagement();
                console.log("キャスト一覧の読み込み完了。");

            }, (error) => {
                console.error("キャスト一覧の読み込みに失敗:", error);
                castError.textContent = 'キャスト一覧の読み込みに失敗しました。';
                castLoadingMessage.textContent = 'エラー';
                castLoadingMessage.classList.add('text-red-500');
            });
        }

        /**
         * 新しいキャストをFirestoreに追加します。
         */
        async function handleAddCast() {
            const castName = newCastNameInput.value.trim();
            if (!castName) {
                castError.textContent = 'キャスト名を入力してください。';
                return;
            }
            
            castError.textContent = '';
            addCastButton.disabled = true;
            
            try {
                // ドキュメントIDをキャスト名から自動生成（衝突を避けるため）
                // 簡潔さのため、キャスト名をハッシュ化してIDとする
                const hashBuffer = await crypto.subtle.digest('SHA-1', new TextEncoder().encode(castName));
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const castId = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                const castDocRef = doc(db, `artifacts/${appId}/public/data/casts/${castId}`);
                
                await setDoc(castDocRef, {
                    name: castName
                });
                
                console.log("キャスト追加成功:", castName);
                newCastNameInput.value = '';
                
            } catch (error) {
                console.error("キャスト追加エラー:", error);
                castError.textContent = 'キャストの追加に失敗しました。';
            } finally {
                addCastButton.disabled = false;
            }
        }
        
        /**
         * ファイルが選択されたときに処理を開始します。
         * @param {Event} event - ファイル選択イベント
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const castId = castSelector.value;
            if (!file || !castId) {
                return;
            }

            resultsContainer.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            searchSection.classList.add('hidden');

            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const csvText = e.target.result;
                    const { header, records } = parseCSV(csvText);
                    
                    // Firestoreへのバッチ書き込み
                    await saveDataToFirestore(castId, records, header);
                    
                    // 完了後、自動的にデータを再読み込み・分析
                    await loadCastData(castId);
                    
                    console.log("CSVデータの保存・分析が完了しました。");
                    
                } catch (error) {
                    console.error("エラーが発生しました:", error);
                    displayError("ファイルの処理中にエラーが発生しました。" + error.message);
                } finally {
                    loadingIndicator.classList.add('hidden');
                    fileInput.value = ''; // ファイル選択をリセット
                }
            };
            
            reader.onerror = function() {
                displayError("ファイルの読み込みに失敗しました。");
                loadingIndicator.classList.add('hidden');
            };

            reader.readAsText(file, 'UTF-8');
        }

        /**
         * CSV文字列をパースしてヘッダーとデータ記録に分割します。
         * @param {string} csvText - CSVファイルの全テキスト
         * @returns {{header: string[], records: string[][]}} パースされたデータ
         */
        function parseCSV(csvText) {
            const lines = csvText.replace(/\r/g, '').trim().split('\n');
            
            // Fantia CSVのヘッダーは3行目にある
            if (lines.length < 4) {
                 throw new Error("CSVデータが不十分か、形式が正しくありません。");
            }

            const parseLine = (line) => {
                const result = [];
                let field = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            field += '"';
                            i++; 
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(field.trim());
                        field = '';
                    } else {
                        field += char;
                    }
                }
                result.push(field.trim()); 
                return result;
            };

            const headerLine = lines[2]; // ヘッダーは3行目
            const dataLines = lines.slice(3); // データは4行目以降

            const header = headerLine.split(',').map(h => h.trim());
            const records = dataLines.filter(line => line.trim() !== '').map(line => parseLine(line));
            
            // 必要な列のインデックスを確認
            const requiredColumns = ['注文ステータス', '注文日時', '商品名', '数量', 'ユーザーID', '合計金額（税込）', '注文ID'];
            const indices = {};
            requiredColumns.forEach(colName => {
                const index = header.indexOf(colName);
                if (index === -1) {
                    throw new Error(`必要な列が見つかりません: ${colName}`);
                }
                indices[colName] = index;
            });
            
            console.log("CSVパース成功。ヘッダー:", header, "レコード数:", records.length);
            return { header, records, indices };
        }

        /**
         * パースされたCSVデータをFirestoreにバッチ書き込みします。
         * 注文IDをドキュメントIDとして使用し、データを上書き（set）します。
         */
        async function saveDataToFirestore(castId, records, header) {
            console.log(`Firestoreへのバッチ書き込み開始... (${records.length}件)`);
            
            // 必要な列のインデックスを取得
            const indices = {
                status: header.indexOf('注文ステータス'),
                date: header.indexOf('注文日時'),
                productName: header.indexOf('商品名'),
                quantity: header.indexOf('数量'),
                userId: header.indexOf('ユーザーID'),
                price: header.indexOf('合計金額（税込）'),
                orderId: header.indexOf('注文ID')
            };
            
            if (indices.orderId === -1) {
                throw new Error("CSVに「注文ID」列が見つかりません。データの上書き・マージに必須です。");
            }
            if (Object.values(indices).includes(-1)) {
                 throw new Error("必要な列（注文ステータス、注文日時など）が見つかりません。");
            }

            // バッチ処理の準備
            let batch = writeBatch(db);
            let operationCount = 0;
            const collectionRef = collection(db, `artifacts/${appId}/public/data/casts/${castId}/orders`);

            for (const record of records) {
                if (record.length < header.length) {
                    console.warn('列数がヘッダーと一致しないため、この行をスキップします:', record);
                    continue;
                }
                
                const orderId = record[indices.orderId];
                if (!orderId) {
                    console.warn('注文IDが空のため、この行をスキップします:', record);
                    continue;
                }
                
                // Firestoreに保存するデータオブジェクトを作成
                const orderData = {
                    orderId: orderId,
                    status: record[indices.status],
                    orderDate: record[indices.date],
                    productName: record[indices.productName],
                    quantity: parseInt(record[indices.quantity], 10) || 0,
                    userId: record[indices.userId],
                    price: parseInt(record[indices.price], 10) || 0,
                };
                
                // 注文IDをドキュメントIDとして設定
                const docRef = doc(collectionRef, orderId);
                batch.set(docRef, orderData); // set = 常に上書き
                
                operationCount++;

                // Firestoreのバッチ書き込みは500件ごとにコミット
                if (operationCount >= 500) {
                    await batch.commit();
                    batch = writeBatch(db); // 新しいバッチを開始
                    operationCount = 0;
                    console.log("バッチをコミットしました (500件)");
                }
            }
            
            // 残りのバッチをコミット
            if (operationCount > 0) {
                await batch.commit();
                console.log(`最後のバッチをコミットしました (${operationCount}件)`);
            }
            
            console.log("Firestoreへのバッチ書き込み完了。");
        }
        
        /**
         * 指定されたキャストの注文データをFirestoreから読み込み、分析します。
         */
        async function loadCastData(castId) {
            console.log(`キャストデータ(ID: ${castId})の読み込みと分析を開始...`);
            resultsContainer.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            searchSection.classList.add('hidden');
            
            try {
                const ordersColRef = collection(db, `artifacts/${appId}/public/data/casts/${castId}/orders`);
                const snapshot = await getDocs(ordersColRef);
                
                const records = [];
                snapshot.forEach(doc => {
                    records.push(doc.data());
                });
                
                console.log(`データ読み込み完了。${records.length}件の注文データを分析します。`);
                
                if (records.length === 0) {
                    displayError("このキャストにはまだ注文データがありません。CSVをアップロードしてください。");
                    searchSection.classList.add('hidden');
                    return;
                }
                
                // 読み込んだデータを分析
                const { dailyStats, productStats, totalRevenue, totalQuantity } = analyzeDataFromFirestore(records);
                
                // グローバル変数に日別データを保存
                globalDailyStats = dailyStats;
                
                // 結果を表示
                displayResults(dailyStats, productStats, totalRevenue, totalQuantity);
                
                searchSection.classList.remove('hidden');
                
            } catch (error) {
                console.error("キャストデータの読み込み・分析エラー:", error);
                displayError("データの分析中にエラーが発生しました: " + error.message);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        

        /**
         * Firestoreから読み込んだデータを分析し、統計情報を計算します。
         * @param {object[]} records - Firestoreの注文ドキュメントの配列
         * @returns {object} 分析結果
         */
        function analyzeDataFromFirestore(records) {
            const dailyStats = {};
            const productStats = {};
            let totalRevenue = 0;
            let totalQuantity = 0;

            for (const record of records) {
                // "取引完了" のデータのみを分析対象とする
                if (record.status === '取引完了') {
                    const date = record.orderDate.split(' ')[0]; // YYYY-MM-DD 形式
                    const productName = record.productName;
                    const quantity = record.quantity || 0;
                    const userId = record.userId;
                    const price = record.price || 0;
                    
                    totalRevenue += price;
                    totalQuantity += quantity;

                    // --- 日別統計 ---
                    if (!dailyStats[date]) {
                        dailyStats[date] = { quantity: 0, revenue: 0, products: {} };
                    }
                    dailyStats[date].quantity += quantity;
                    dailyStats[date].revenue += price;
                    
                    // --- 日別・商品別統計 ---
                    if (!dailyStats[date].products[productName]) {
                        dailyStats[date].products[productName] = { quantity: 0, revenue: 0 };
                    }
                    dailyStats[date].products[productName].quantity += quantity;
                    dailyStats[date].products[productName].revenue += price;
                    
                    // --- 商品別統計 ---
                    if (!productStats[productName]) {
                        productStats[productName] = { quantity: 0, revenue: 0, uniqueUsers: new Set() };
                    }
                    productStats[productName].quantity += quantity;
                    productStats[productName].revenue += price;
                    productStats[productName].uniqueUsers.add(userId);
                }
            }
            console.log("データ分析完了。");
            return { dailyStats, productStats, totalRevenue, totalQuantity };
        }

        /**
         * 分析結果をHTMLとして画面に表示します。
         */
        function displayResults(dailyStats, productStats, totalRevenue, totalQuantity) {
            resultsContainer.innerHTML = `
                ${createSummaryCard(totalRevenue, totalQuantity, productStats)}
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${createProductStatsTable(productStats)}
                    ${createDailyStatsTable(dailyStats)}
                </div>
            `;
            // 検索フィルターをリセット（新しいデータが表示されたため）
            applySearchFilter();
        }
        
        /**
         * 全体サマリーカードのHTMLを生成します。
         */
        function createSummaryCard(totalRevenue, totalQuantity, productStats) {
            const uniqueProductCount = Object.keys(productStats).length;
            return `
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">全体サマリー（取引完了のみ）</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-sm text-gray-500">総売上金額</p>
                        <p class="text-2xl font-semibold text-blue-600">${totalRevenue.toLocaleString()}円</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">総販売個数</p>
                        <p class="text-2xl font-semibold text-blue-600">${totalQuantity.toLocaleString()}個</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">販売商品数</p>
                        <p class="text-2xl font-semibold text-blue-600">${uniqueProductCount}種類</p>
                    </div>
                </div>
            </div>
            `;
        }
        
        /**
         * 商品別レポートのHTMLを生成します。
         */
        function createProductStatsTable(productStats) {
            const sortedProducts = Object.entries(productStats).sort(([,a], [,b]) => b.revenue - a.revenue);
            
            let tableRows = sortedProducts.map(([name, stats]) => {
                const avgPurchase = stats.uniqueUsers.size > 0 ? stats.quantity / stats.uniqueUsers.size : 0;
                // data-name属性に商品名を設定（検索用）
                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50" data-search-name="${name.toLowerCase()}">
                        <td class="p-3 text-sm text-gray-700">${name}</td>
                        <td class="p-3 text-right font-medium">${stats.quantity.toLocaleString()}</td>
                        <td class="p-3 text-right">${stats.uniqueUsers.size.toLocaleString()}</td>
                        <td class="p-3 text-right">${avgPurchase.toFixed(2)}</td>
                        <td class="p-3 text-right font-semibold text-green-600">${stats.revenue.toLocaleString()}円</td>
                    </tr>
                `;
            }).join('');
            
            if (!tableRows) {
                tableRows = '<tr><td colspan="5" class="text-center p-4 text-gray-500">データがありません。</td></tr>';
            }

            return `
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">商品別レポート</h2>
                    <div class="overflow-x-auto max-h-[60vh]">
                        <table id="productStatsTable" class="w-full min-w-[600px]">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">商品名</th>
                                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">販売個数</th>
                                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">購入者数</th>
                                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">平均/人</th>
                                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">売上</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        /**
         * 日別レポートのHTMLを生成します。
         */
        function createDailyStatsTable(dailyStats) {
            const sortedDates = Object.keys(dailyStats).sort((a, b) => new Date(b) - new Date(a));
            
            let tableRows = sortedDates.map(date => `
                <tr class="border-b border-gray-200 hover:bg-gray-50 cursor-pointer" onclick="window.showDailyDetailsModal('${date}')">
                    <td class="p-3 text-sm text-gray-700">${date}</td>
                    <td class="p-3 text-right font-medium">${dailyStats[date].quantity.toLocaleString()}</td>
                    <td class="p-3 text-right font-semibold text-green-600">${dailyStats[date].revenue.toLocaleString()}円</td>
                </tr>
            `).join('');

            if (!tableRows) {
                tableRows = '<tr><td colspan="3" class="text-center p-4 text-gray-500">データがありません。</td></tr>';
            }

            return `
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">日別レポート (クリックで詳細)</h2>
                    <div class="overflow-x-auto max-h-[60vh]">
                        <table class="w-full">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">日付</th>
                                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">販売個数</th>
                                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">売上</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        /**
         * エラーメッセージを表示します。
         */
        function displayError(message) {
            resultsContainer.innerHTML = `
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert">
                    <p class="font-bold">エラー</p>
                    <p>${message}</p>
                </div>
            `;
        }
        
        /**
         * 検索フィルターを適用します。
         */
        function applySearchFilter() {
            const query = searchInput.value.toLowerCase().trim();
            
            // 商品別レポートのフィルタリング
            const productTable = document.getElementById('productStatsTable');
            if (productTable) {
                const rows = productTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                for (const row of rows) {
                    const name = row.dataset.searchName;
                    if (name) {
                        if (name.includes(query)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                }
            }
            
            // (もしモーダルが開いていれば) モーダル内のフィルタリング
            const modalTable = document.getElementById('modalProductStatsTable');
            if (modalTable && !dailyDetailsModal.classList.contains('opacity-0')) {
                const modalRows = modalTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                for (const row of modalRows) {
                    const name = row.dataset.searchName;
                    if (name) {
                        if (name.includes(query)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                }
            }
        }
        
        // --- モーダル制御 ---
        // グローバルスコープに関数を公開
        
        /**
         * 日別詳細モーダルを表示します。
         * @param {string} date - 表示する日付 (YYYY-MM-DD)
         */
        window.showDailyDetailsModal = (date) => {
            const data = globalDailyStats[date];
            if (!data) return;

            modalTitle.textContent = `${date} の商品別レポート`;
            
            const products = data.products;
            const sortedProducts = Object.entries(products).sort(([,a], [,b]) => b.quantity - a.quantity);
            
            const productRows = sortedProducts.map(([name, stats]) => `
                <tr class="border-t border-gray-200" data-search-name="${name.toLowerCase()}">
                    <td class="p-3 text-sm text-gray-600">${name}</td>
                    <td class="p-3 text-right font-medium">${stats.quantity.toLocaleString()}</td>
                    <td class="p-3 text-right text-green-600">${stats.revenue.toLocaleString()}円</td>
                </tr>
            `).join('');

            modalBody.innerHTML = `
                <table id="modalProductStatsTable" class="w-full text-sm">
                    <thead class="border-b">
                        <tr>
                            <th class="pb-2 text-left font-semibold text-gray-600">商品名</th>
                            <th class="pb-2 text-right font-semibold text-gray-600">販売個S数</th>
                            <th class="pb-2 text-right font-semibold text-gray-600">売上</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productRows}
                    </tbody>
                </table>
            `;
            
            // モーダルを表示
            dailyDetailsModal.classList.remove('opacity-0', 'pointer-events-none');
            dailyDetailsModal.firstElementChild.classList.remove('scale-95');
            
            // 現在の検索フィルターをモーダルにも適用
            applySearchFilter();
        }

        /**
         * 日別詳細モーダルを非表示にします。
         */
        window.hideDailyDetailsModal = () => {
            dailyDetailsModal.classList.add('opacity-0', 'pointer-events-none');
            dailyDetailsModal.firstElementChild.classList.add('scale-95');
        }

        // --- アプリケーションの起動 ---
        // DOMが読み込まれたらFirebaseの初期化を開始
        document.addEventListener('DOMContentLoaded', initializeMainApp);

    </script>

</body>
</html>

